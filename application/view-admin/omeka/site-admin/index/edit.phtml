<?php
$this->htmlElement('body')->appendAttribute('class', 'sites add');
$this->headScript()->appendFile($this->assetUrl('js/jstree/jstree.min.js', 'Omeka'));
$this->headLink()->appendStylesheet($this->assetUrl('css/jstree.css', 'Omeka'));
$escape = $this->plugin('escapeHtml');
$form->prepare();
$delete = $this->translate('Delete');
$restore = $this->translate('Restore');
$roles = array(
    'viewer' => $this->translate('Viewer'),
    'editor' => $this->translate('Editor'),
    'admin' => $this->translate('Admin'),
);
?>
<?php echo $this->pageTitle(sprintf($this->translate('Edit Site: “%s”'), $site->title())); ?>
<?php echo $this->form()->openTag($form); ?>
<div id="page-actions">
        <?php if ($site->isPublic()): ?>
        <a href="#"
        class="o-icon-public button"
        aria-label=" <?php echo $this->translate('Make private'); ?>"
        title=" <?php echo $this->translate('Make private'); ?>"></a>
        <input type="hidden" name="o:is_public" value="1">
        <?php else: ?>
        <a href="#"
        class="o-icon-private button"
        aria-label=" <?php echo $this->translate('Make public'); ?>"
        title=" <?php echo $this->translate('Make public'); ?>"></a>
        <input type="hidden" name="o:is_public" value="0">
        <?php endif; ?>
    <a href="#" class="delete button sidebar-confirm" data-sidebar-confirm-url="<?php echo $escape($site->url('delete')); ?>">Delete</a>
    <button><?php echo $this->translate('Save'); ?></button>
</div>
<nav class="section-nav">
    <ul>
        <li class="active"><a href="#admin"><?php echo $this->translate('Admin'); ?></a></li>
        <li><a href="#pages"><?php echo $this->translate('Pages'); ?></a></li>
        <li><a href="#nav"><?php echo $this->translate('Navigation'); ?></a></li>
        <li><a href="#permissions"><?php echo $this->translate('User permissions'); ?></a></li>
    </ul>
</nav>
<fieldset id="admin" class="section active">
<legend><?php echo $this->translate('Admin'); ?></legend>
<?php echo $this->formElements($form); ?>
</fieldset>
<fieldset id="pages" class="section">
<legend><?php echo $this->translate('Pages'); ?></legend>
<?php echo $site->link($this->translate('Add a Page'), 'add-page', array('class' => 'button')); ?>

<?php
$pages = $site->pages();
if ($pages):
?>
    <table id="page-list">
        <thead>
            <th><?php echo $this->translate('Title'); ?></th>
            <th><?php echo $this->translate('Slug'); ?></th>
            <th></th>
        </thead>
        <tbody>
<?php foreach ($pages as $page): ?>
        <tr class="page value">
            <td>
                <span class="restore-value"><?php echo $this->translate('Page to be removed'); ?></span>
                <?php echo $page->title(); ?>
                <input type="hidden" name="o:page[][o:id]" value="<?php echo $escape($page->id()); ?>">
            </td>
            <td><?php echo $page->slug(); ?></td>
            <td>
                <ul class="actions">
                    <li><?php echo $page->link('', 'edit', array(
                        'class' => 'o-icon-edit',
                        'aria-label' => $this->translate('Edit'),
                        'title' => $this->translate('Edit'),
                    )); ?></li>
                    <li><a href="#" class="o-icon-delete" aria-label="<?php echo $delete; ?>" title="<?php echo $delete; ?>"></a></li>
                    <li><a href="#" class="o-icon-undo" aria-label="<?php echo $restore; ?>" title="<?php echo $restore; ?>"></a></li>
                </ul>
            </td>
        </tr>
<?php endforeach; ?>
        </tbody>
    </table>
<?php endif; ?>
</fieldset>

<fieldset id="nav" class="section">
    <div id="nav-tree"></div>
    <div id="nav-selector" class="sidebar">
    <p>Click on a page to add it to the navigation.</p>
    <input type="text" class="page-selector-filter" placeholder="Filter pages">
    <?php if ($pages): ?>
    <ul id="nav-pages">
    <?php foreach ($pages as $page): ?>
        <li class="nav-page"
            data-type="page"
            data-id="<?php echo $page->id(); ?>"
            data-title="<?php echo $page->title(); ?>"
            data-slug="<?php echo $page->slug(); ?>">
            <?php echo $page->title(); ?> (<?php echo $page->slug(); ?>)
        </li>
    <?php endforeach; ?>
    </ul>
    <?php else: ?>
    <p>This site has no pages</p>
    <?php endif; ?>
    </div>
</fieldset>

<fieldset id="permissions" class="section">
<?php $sitePermissions = $site->sitePermissions(); ?>
    <table id="site-user-permissions" class="<?php echo count($sitePermissions) ? '' : 'empty'; ?>">
        <thead>
            <tr>
                <th scope="col"><?php echo $this->translate('User'); ?></th>
                <th scope="col"><?php echo $this->translate('Role'); ?></th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            <?php 
            $index = 1;
            foreach($sitePermissions as $sitePermission): 
            $user = $sitePermission->user();
            ?>
            <tr class="user value">
                <td class="user-meta">
                    <span class="restore-value"><?php echo $this->translate('User to be removed'); ?></span>
                    <span class="user-name"><?php echo $escape($user->name()); ?> (<?php echo $escape($user->email()); ?>)</span>
                    <input type="hidden" class="user-id" name="o:site_permission[<?php echo $index; ?>][o:user][o:id]" value="<?php echo $escape($user->id()); ?>">
                </td>
                <td><select name="o:site_permission[<?php echo $index; ?>][o:role]">
                    <?php
                    foreach ($roles as $key => $value):
                    $selected = $key === $sitePermission->role() ? true : false;
                    ?>
                    <option value="<?php echo $key; ?>"<?php echo $selected ? ' selected' : null; ?>><?php echo $value; ?></option>
                    <?php endforeach; ?>
                </select></td>
                <td>
                    <ul class="actions">
                        <li><a href="#" class="o-icon-delete" aria-label="<?php echo $delete; ?>" title="<?php echo $delete; ?>"></a></li>
                        <li><a href="#" class="o-icon-undo" aria-label="<?php echo $restore; ?>" title="<?php echo $restore; ?>"></a></li>
                    </ul>
                </td>
                <?php $index++; ?>
            </tr>
            <?php endforeach; ?>
        </tbody>
    </table>

    <div class="no-resources">
        <p><?php echo $this->translate('This site has no users. Add users using the interface to the right.'); ?></p>
    </div>

    <div id="site-user-selector" class="selector sidebar">
        <p><?php echo $this->translate('Click on a user to add them to the site.'); ?></p>
        <input type="text" class="selector-filter" placeholder="Filter users">
        <ul id="new-site-user">
            <li class="show"><?php echo $this->translate('All Users'); ?> (<?php echo count($users); ?>)
                <ul>
                <?php
                    $usersByInitial = array();
                    $initial = substr($users[0]->name(), 0, 1);
                    foreach ($users as $user) {
                        $userInitial = substr($user->name(), 0, 1);
                        if ($userInitial !== $initial) {
                            $initial = $userInitial;
                        }
                        $usersByInitial[$initial][] = $user;
                    }
                ?>
                <?php foreach ($usersByInitial as $initial => $users): ?>
                    <li class="selector-parent"><span>
                        <?php echo $initial; ?></span> 
                        (<span class="selector-child-count"><?php echo count($usersByInitial[$initial]); ?></span>)
                        <ul>
                        <?php foreach($users as $user): ?>
                            <li class="selector-child" data-child-search="<?php echo $escape($user->name() . ' (' . $user->email() . ')'); ?>" data-user-id="<?php echo $escape($user->id()); ?>"><span><?php echo $escape($user->name()); ?><br><?php echo $escape($user->email()); ?></span></li>
                        <?php endforeach; ?>
                        </ul>
                <?php endforeach; ?>
                </ul>
            </li>
        </ul>
    </div>
</fieldset>
<?php echo $this->form()->closeTag(); ?>

<div class="sidebar">
    <a href="#"
        class="sidebar-close o-icon-close"
        aria-label="<?php echo $escape($this->translate('Close')); ?>"
        title="<?php echo $escape($this->translate('Close')); ?>"></a>
    <div id="sidebar-confirm">
        <h2><?php echo $this->translate('Delete Site'); ?></h2>
        <p><?php echo $this->translate('Are you sure you would like to delete this site?'); ?></p>
        <?php echo $this->form($confirmForm); ?>
    </div>
    <div class="sidebar-content"></div>
</div>

<?php
$userRowTemplate = '
<tr class="user value">
    <td class="user-meta">
        <span class="restore-value">' . $this->translate('User to be removed') . '</span>
        <span class="user-name"></span>
        <input type="hidden" class="user-id" name="o:site_permission[__index__][o:user][o:id]">
    </td>
    <td><select name="o:site_permission[__index__][o:role]">';
foreach ($roles as $key => $value) {
    $userRowTemplate .= '<option value="' . $key . '">' . $value . '</option>';
}
$userRowTemplate .= '</select></td>
    <td>
        <ul class="actions">
            <li><a href="#" class="o-icon-delete" aria-label="' . $delete . '" title="' . $delete . '"></a></li>
            <li><a href="#" class="o-icon-undo" aria-label="' . $restore . '" title="' . $restore . '"></a></li>
        </ul>
    </td>
</tr>
';
?>

<span id="user-row-template" data-template="<?php echo $escape($userRowTemplate); ?>">

<script>
$('#content').on('click', '.o-icon-delete,.o-icon-undo', function(e) {
    e.preventDefault();
    $(this).parents('tr').toggleClass('delete');
});

$('#content').on('click', '.o-icon-delete', function() {
    $(this).parents('tr').find('input[type="hidden"]').prop('disabled', true);
});

$('#content').on('click', '.o-icon-undo', function() {
    $(this).parents('.user.value').find('input[type="hidden"]').prop('disabled', false);
});

$('#permissions .selector .selector-child').click(function() {
    var user = $(this);
    var userId = user.data('user-id');
    var userText = user.data('child-search');
    var permissionsTable = $('#site-user-permissions');
    if (permissionsTable.find('.user-id[value="' + userId + '"]').length) {
        // Do not add existing users.
        return;
    }
    var index = permissionsTable.find('.user').length;
    if (!index) {
        permissionsTable.removeClass('empty');
    }
    var template = $($.parseHTML($('#user-row-template').data('template')));
    template.find('.user-name').text(userText);
    template.find('.user-id').val(userId);
    template.find(':input').each(function() {
        // Find and replace indexes for all inputs.
        var thisInput = $(this);
        var name = thisInput.attr('name').replace('[__index__]', '[' + index + ']');
        thisInput.attr('name', name);
    });
    permissionsTable.find('tbody').append(template);
});

$('.section-nav a').click(function() {
    $('fieldset .sidebar').removeClass('active');
    var sectionId = $(this).attr('href');
    var section = $(sectionId);
    if (section.find('.sidebar').length > 0 && !$('body').hasClass('sidebar-open')) {
        $('body').addClass('sidebar-open');
    } else if (section.find('.sidebar').length == 0 && $('.sidebar.active').length == 0) {
        $('body').removeClass('sidebar-open');
    }
    section.find('.sidebar').addClass('active');
});

$('.page-selector-filter').on('keydown', function(e) {
    if (e.keyCode == 13) {
        e.stopPropagation();
        e.preventDefault();
    }
});

// Property selector, filter properties.
$('.page-selector-filter').on('keyup', (function() {
    var timer = 0;
    return function() {
        clearTimeout(timer);
        timer = setTimeout(pageFilterSelector.bind(this), 400);
    }
})())

var pageFilterSelector = function() {
    var filter = $(this).val().toLowerCase();
    var selector = $(this).closest('.selector');
    var parent = $("#nav-pages");
    parent.find('li.nav-page').each(function() {
        var child = $(this);
        var label = child.data('title').toLowerCase();
        if (label.indexOf(filter) > -1) {
            // Label contains the filter string. Show the child.
            child.show();
        } else {
            // Label doesn't contain the filter string. Hide the child.
            child.hide();
        }
    });
}

/**
 * RemoveNode Plugin for jsTree
 */
$.jstree.plugins.removenode = function(options, parent) {
    var removeIcon = $('<i>', {
        class: 'jstree-icon jstree-removenode-remove',
        attr:{role:'presentation'}
    });
    var undoIcon = $('<i>', {
        class: 'jstree-icon jstree-removenode-undo',
        attr:{role:'presentation'}
    });
    this.bind = function() {
        parent.bind.call(this);
        this.element.on(
            'click.jstree',
            '.jstree-removenode-remove, .jstree-removenode-undo',
            $.proxy(function(e) {
                var icon = $(e.currentTarget);
                var node = icon.closest('.jstree-node');
                var nodeObj = this.get_node(node);
                icon.hide();
                if (icon.hasClass('jstree-removenode-remove')) {
                    // Handle node removal.
                    icon.siblings('.jstree-removenode-undo').show();
                    node.addClass('jstree-removenode-removed');
                    nodeObj.data.remove = true;
                } else {
                    // Handle undo node removal.
                    icon.siblings('.jstree-removenode-remove').show();
                    node.removeClass('jstree-removenode-removed');
                    nodeObj.data.remove = false;
                }
            }, this)
        );
    };
    this.redraw_node = function(node, deep, is_callback, force_render) {
        node = parent.redraw_node.apply(this, arguments);
        if (node) {
            // Add remove/undo icons to every node.
            var nodeJq = $(node);
            var anchor = nodeJq.children('.jstree-anchor');
            var removeIconClone = removeIcon.clone();
            var undoIconClone = undoIcon.clone();
            anchor.append(removeIconClone);
            anchor.append(undoIconClone);

            // Carry over the removed/not-removed state
            var data = this.get_node(node).data;
            if (data.remove === 'undefined' || data.remove) {
                removeIconClone.hide();
                nodeJq.addClass('jstree-removenode-removed');
            } else {
                undoIconClone.hide();
                nodeJq.removeClass('jstree-removenode-removed');
            }
        }
        return node;
    };
};

// Initialize the jsTree tree
var navTree = $('#nav-tree');
navTree.jstree({
    'core': {
        'check_callback': true,
        'data': <?php echo json_encode($navTree); ?>,
    },
    'plugins': ['dnd','removenode']
}).on('loaded.jstree', function() {
    // Open all nodes by default.
    navTree.jstree(true).open_all();
}).on('move_node.jstree', function(e, data) {
    // Open node after moving it.
    var parent = navTree.jstree(true).get_node(data.parent);
    navTree.jstree(true).open_all(parent);
});
$('#nav-pages').on('click', '.nav-page', function(e) {
    var thisPage = $(this);
    var data = {
        type: thisPage.data('type'),
        id: thisPage.data('id')
    };
    var text = thisPage.data('title') + ' (' + thisPage.data('slug') + ')';
    navTree.jstree(true).create_node('#', {data: data, text: text});
    Omeka.scrollTo($('#nav-tree').find('[role="treeitem"]').last());
});
$('form').submit(function(e) {
    var json = navTree.jstree(true).get_json();
    $('<input>', {
        'type': 'hidden',
        'name': 'jstree',
        'val': JSON.stringify(json)
    }).appendTo('form');
});
</script>

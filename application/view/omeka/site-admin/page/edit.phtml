<?php
$this->htmlElement('body')->appendAttribute('class', 'site-pages add sidebar-open');
$this->headScript()->appendFile($this->assetUrl('js/sortable.js', 'Omeka'));
$this->blockLayout()->prepare();
$form->prepare();
$escape = $this->plugin('escapeHtml');
$escapeAttr = $this->plugin('escapeHtmlAttr');
?>
<?php echo $this->pageTitle(sprintf($this->translate('Edit Page: “%s”'), $page->title())); ?>

<?php echo $this->form()->openTag($form); ?>
<div id="page-actions">
    <button><?php echo $this->translate('Save'); ?></button>
</div>

<div class="breadcrumbs">
    <?php echo $site->link($site->title(), null, array('class' => 'page-site')); ?>
    <span class="page-title"><?php echo $page->title(); ?></span>
</div>

<?php echo $this->formElements($form); ?>

<div id="blocks">
    <?php foreach ($page->blocks() as $index => $block): ?>
    <div class="block">
        <div><?php echo $this->blockLayout()->form($index, $block); ?></div>
        <span class="sortable-handle">...</span>
    </div>
    <?php endforeach; ?>
</div>

<?php echo $this->form()->closeTag(); ?>

<div class="active sidebar">
    <label for="new-block">
        <?php echo $this->translate('Add New Block'); ?>
    </label>
    <select id="new-block">
        <option value=""><?php echo $this->translate('Select layout'); ?></option>
        <?php foreach ($this->blockLayout()->getLayouts() as $layout): ?>
        <option value="<?php echo $escapeAttr($layout); ?>">
            <?php echo $escape($this->blockLayout()->getLayoutLabel($layout)); ?>
        </option>
        <?php endforeach; ?>
    </select>
</div>

<script type="text/javascript">
var list = document.getElementById('blocks');
new Sortable(list, {
    draggable: ".block",
    handle: ".sortable-handle"
});

$('#new-block').change(function() {
    var index = $('.block').length;
    $.post(
        '<?php echo $this->url('admin/site/page', array('action' => 'block'), true); ?>',
        {index: index, layout: $(this).val()}
    ).done(function(data) {
        $('#blocks').append('<div class="block">' + data + '</div>');
    });
    $('#new-block').prop('selectedIndex', 0); // reset select
});
</script>

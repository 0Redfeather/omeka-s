<?php
if ('grid' === $page->layout()) {
    $pageLayoutData = $page->layoutData();
    echo <<<STYLE
    <style>
    #grid {
        display: grid;
        grid-template-columns: repeat({$pageLayoutData['grid_columns']}, 1fr);
        gap: 10px;
    }
    #grid > div {
        border: 1px solid black;
        min-height: 50px;
    }
    </style>
    <div id="grid">
    STYLE;
}
$layouts = [];
foreach ($page->blocks() as $block) {
    if (!array_key_exists($block->layout(), $layouts)) {
        // Prepare render only once per layout type.
        $layouts[$block->layout()] = null;
        $this->blockLayout()->prepareRender($block->layout());
    }
    if ('grid' === $page->layout()) {
        $blockPageLayoutData = $block->pageLayoutData();
        $gridPosition = $blockPageLayoutData['grid_position'] ?? 1;
        $gridSpan = $blockPageLayoutData['grid_span'] ?? 1;
        if ($gridPosition && $gridSpan) {
            $gridColumn = sprintf('%s / span %s', $gridPosition, $gridSpan);
        } elseif ($gridSpan) {
            $gridColumn = sprintf('span %s', $gridSpan);
        } else {
            $gridColumn = $gridPosition;
        }
        echo sprintf('<div style="grid-column: %s">', $gridColumn);
    }
    echo $this->blockLayout()->render($block);
    if ('grid' === $page->layout()) {
        echo '</div>';
    }
}
if ('grid' === $page->layout()) {
    echo '</div>';
}

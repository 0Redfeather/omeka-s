<?php
$translate = $this->plugin('translate');

// Prepare the "item_set" query.
$itemSets = (isset($query['item_set']) && is_array($query['item_set'])) ? $query['item_set'] : [];
$itemSets = array_filter($itemSets, function ($itemSet) {
    return (
        isset($itemSet['type'])
        && in_array($itemSet['type'], ['in', 'nin'])
        && isset($itemSet['id'])
        && is_numeric($itemSet['id'])
    );
});
// Include the legacy "item_set_id" query.
$itemSetIds = $query['item_set_id'] ?? [];
if (!is_array($itemSetIds)) {
    $itemSetIds = [$itemSetIds];
}
foreach ($itemSetIds as $itemSetId) {
    if (is_numeric($itemSetId)) {
        $itemSets[] = ['type' => 'in', 'id' => $itemSetId];
    }
}
// Set the default state if no item sets are set.
if (!$itemSets) {
    $itemSets = [['type' => 'in', 'id' => '']];
}
?>
<div id="item-sets" class="field removable multi-value" role="group">
    <div class="field-meta">
        <span id="by-item-set-label" class="label"><?php echo $translate('Search by item set'); ?></span>
        <?php echo $this->hyperlink('', '#', ['class' => 'expand', 'title' => $translate('Expand')]); ?>
        <div class="collapsible">
            <div class="field-description"><?php echo $translate('Searches for items that are assigned to any of these item sets.'); ?></div>
        </div>
        <button type="button" class="add-value o-icon-add button" aria-label="<?php echo $translate('Add new item set'); ?>" title="<?php echo $translate('Add new item set'); ?>"></button>
    </div>
    <div class="inputs">
        <?php foreach ($itemSets as $index => $itemSet): ?>
        <div class="value">
            <select name="<?php echo sprintf('item_set[%s][type]', $index); ?>">
                <option value="in"<?php echo ('in' === $itemSet['type']) ? ' selected' : ''; ?>><?php echo $translate('Is in'); ?></option>
                <option value="nin"<?php echo ('nin' === $itemSet['type']) ? ' selected' : ''; ?>><?php echo $translate('Is not in'); ?></option>
            </select>
            <?php echo $this->itemSetSelect([
                'name' => sprintf('item_set[%s][id]', $index),
                'attributes' => [
                    'value' => $itemSet['id'],
                ],
                'options' => [
                    'disable_group_by_owner' => $this->status()->isSiteRequest(),
                ],
            ]); ?>
            <button type="button" class="o-icon-delete remove-value button" aria-label="<?php echo $translate('Remove value'); ?>" title="<?php echo $translate('Remove value'); ?>"></button>
        </div>
        <?php endforeach; ?>
    </div>
</div>
